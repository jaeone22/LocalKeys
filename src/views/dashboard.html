<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LocalKeys</title>
        <link rel="stylesheet" href="../styles/common.css" />
    </head>
    <body>
        <div class="container">
            <div class="page-header dashboard-header">
                <h1 class="page-title" id="page-title">Projects</h1>
                <div class="header-actions">
                    <button class="btn" id="add-project-btn">Add Project</button>
                    <button class="btn btn-secondary" id="logs-btn">Logs</button>
                    <button class="btn btn-secondary" id="lock-btn">Lock</button>
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" id="settings-dropdown-btn">
                            <span class="lk-icon lk-icon-ellipsis" aria-hidden="true"></span>
                        </button>
                        <div class="dropdown-menu hidden" id="dropdown-settings">
                            <button class="dropdown-item" id="install-cli-btn">Install CLI</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 검색 바 -->
            <div class="search-bar">
                <input type="text" class="search-input" id="search-input" placeholder="Search projects..." />
                <span class="search-icon lk-icon lk-icon-search" aria-hidden="true"></span>
            </div>

            <!-- 프로젝트 목록 -->
            <div id="projects-container">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- 프로젝트 추가 모달 -->
        <div id="add-project-modal" class="modal-overlay hidden">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="modal-title">Add New Project</h3>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label for="project-name" id="label-project-name">Project Name</label>
                        <input type="text" id="project-name" placeholder="Enter project name" autocomplete="off" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-add-project">Cancel</button>
                    <button class="btn" id="confirm-add-project">Add Project</button>
                </div>
            </div>
        </div>

        <script src="../modules/i18n-helper.js"></script>
        <script src="../modules/notification.js"></script>

        <script>
            document.addEventListener("DOMContentLoaded", async function () {
                // 다국어 초기화
                await i18n.init();

                // UI 번역 적용
                document.getElementById("page-title").textContent = i18n.t("dashboard.title");
                document.getElementById("add-project-btn").textContent = i18n.t("dashboard.addProject");
                document.getElementById("logs-btn").textContent = i18n.t("dashboard.logs");
                document.getElementById("lock-btn").textContent = i18n.t("dashboard.lock");
                document.getElementById("install-cli-btn").textContent = i18n.t("dashboard.installCli");
                document.getElementById("search-input").placeholder = i18n.t("dashboard.searchPlaceholder");
                document.getElementById("modal-title").textContent = i18n.t("dashboard.addProjectModal.title");
                document.getElementById("label-project-name").textContent = i18n.t("dashboard.addProjectModal.label");
                document.getElementById("project-name").placeholder = i18n.t("dashboard.addProjectModal.placeholder");
                document.getElementById("cancel-add-project").textContent = i18n.t("common.cancel");
                document.getElementById("confirm-add-project").textContent = i18n.t("dashboard.addProjectModal.add");

                const projectsContainer = document.getElementById("projects-container");

                const searchInput = document.getElementById("search-input");

                const addProjectBtn = document.getElementById("add-project-btn");

                const logsBtn = document.getElementById("logs-btn");

                const lockBtn = document.getElementById("lock-btn");

                const installCliBtn = document.getElementById("install-cli-btn");

                const addProjectModal = document.getElementById("add-project-modal");

                const projectNameInput = document.getElementById("project-name");

                const cancelAddProject = document.getElementById("cancel-add-project");

                const confirmAddProject = document.getElementById("confirm-add-project");

                const settingsDropdownBtn = document.getElementById("settings-dropdown-btn");

                let projects = [];

                let filteredProjects = [];

                // 프로젝트 로드

                async function loadProjects() {
                    try {
                        const result = await window.localkeys.projects.get();

                        if (result.success) {
                            projects = result.data;

                            filteredProjects = projects;

                            renderProjects();
                        } else {
                            notificationManager.error(i18n.t("dashboard.notifications.failedToLoad"));
                        }
                    } catch (error) {
                        notificationManager.error(i18n.t("dashboard.notifications.failedToLoad"));
                    }
                }

                function createProjectCard(project) {
                    const card = document.createElement("div");

                    card.className = "project-card";

                    card.onclick = () => openProject(project.name);

                    const nameDiv = document.createElement("div");

                    nameDiv.className = "project-name";

                    nameDiv.textContent = project.name;

                    const dateDiv = document.createElement("div");

                    dateDiv.className = "project-date";

                    dateDiv.textContent = i18n.t("dashboard.updated", { time: formatDate(project.updatedAt) });

                    const statsDiv = document.createElement("div");

                    statsDiv.className = "project-stats";

                    const secretCountDiv = document.createElement("div");

                    secretCountDiv.className = "secret-count";

                    secretCountDiv.textContent = i18n.t("dashboard.secretCount", { count: project.secretCount });

                    const actionsDiv = document.createElement("div");

                    actionsDiv.className = "project-actions";

                    const dropdownDiv = document.createElement("div");

                    dropdownDiv.className = "dropdown";

                    const dropdownBtn = document.createElement("button");

                    dropdownBtn.className = "btn btn-secondary dropdown-toggle";

                    const ellipsisIcon = document.createElement("span");
                    ellipsisIcon.className = "lk-icon lk-icon-ellipsis";
                    ellipsisIcon.setAttribute("aria-hidden", "true");
                    dropdownBtn.appendChild(ellipsisIcon);

                    dropdownBtn.onclick = (e) => {
                        e.stopPropagation();

                        toggleDropdown(project.name);
                    };

                    const dropdownMenu = document.createElement("div");

                    dropdownMenu.className = "dropdown-menu hidden";

                    dropdownMenu.id = `dropdown-${project.name}`;

                    const deleteBtn = document.createElement("button");

                    deleteBtn.className = "dropdown-item";

                    deleteBtn.textContent = i18n.t("dashboard.deleteProject.deleteBtn");

                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();

                        deleteProject(project.name);
                    };

                    dropdownMenu.appendChild(deleteBtn);

                    dropdownDiv.appendChild(dropdownBtn);

                    dropdownDiv.appendChild(dropdownMenu);

                    actionsDiv.appendChild(dropdownDiv);

                    statsDiv.appendChild(secretCountDiv);

                    statsDiv.appendChild(actionsDiv);

                    card.appendChild(nameDiv);

                    card.appendChild(dateDiv);

                    card.appendChild(statsDiv);

                    return card;
                }

                function createEmptyStateElement() {
                    const emptyState = document.createElement("div");

                    emptyState.className = "empty-state";

                    const icon = document.createElement("div");

                    icon.className = "empty-state-icon";

                    icon.classList.add("lk-icon", "lk-icon-folder", "lk-icon-xl");
                    icon.setAttribute("aria-hidden", "true");

                    const title = document.createElement("div");

                    title.className = "empty-state-title";

                    title.textContent = i18n.t("dashboard.emptyState.title");

                    const description = document.createElement("div");

                    description.className = "empty-state-description";

                    description.textContent = projects.length === 0 ? i18n.t("dashboard.emptyState.descriptionEmpty") : i18n.t("dashboard.emptyState.descriptionSearch");

                    emptyState.appendChild(icon);

                    emptyState.appendChild(title);

                    emptyState.appendChild(description);

                    return emptyState;
                }

                // 프로젝트 렌더링

                function renderProjects() {
                    projectsContainer.innerHTML = ""; // Clear existing content

                    if (filteredProjects.length === 0) {
                        projectsContainer.appendChild(createEmptyStateElement());

                        return;
                    }

                    const grid = document.createElement("div");

                    grid.className = "projects-grid";

                    filteredProjects.forEach((project) => {
                        grid.appendChild(createProjectCard(project));
                    });

                    projectsContainer.appendChild(grid);
                }

                // 프로젝트 열기

                function openProject(projectName) {
                    window.location.href = `project.html?name=${encodeURIComponent(projectName)}`;
                }

                // 프로젝트 삭제

                async function deleteProject(projectName) {
                    if (!confirm(i18n.t("dashboard.deleteProject.confirm", { name: projectName }))) {
                        return;
                    }

                    try {
                        const result = await window.localkeys.projects.delete(projectName);

                        if (result.success) {
                            await loadProjects();

                            notificationManager.success(i18n.t("dashboard.notifications.projectDeleted", { name: projectName }));
                        } else {
                            notificationManager.error(i18n.t("dashboard.notifications.failedToDelete"));
                        }
                    } catch (error) {
                        notificationManager.error(i18n.t("dashboard.notifications.failedToDelete"));
                    }
                }

                // 프로젝트 추가 모달 표시

                function showAddProjectModal() {
                    addProjectModal.classList.remove("hidden");

                    projectNameInput.value = "";

                    // 다음 프레임에서 애니메이션 시작

                    requestAnimationFrame(() => {
                        addProjectModal.classList.add("show");
                    });

                    projectNameInput.focus();
                }

                // 프로젝트 추가 모달 숨기기

                function hideAddProjectModal() {
                    addProjectModal.classList.remove("show");

                    addProjectModal.classList.add("closing");

                    // 애니메이션 완료 후 모달 완전히 숨기기

                    setTimeout(() => {
                        addProjectModal.classList.add("hidden");

                        addProjectModal.classList.remove("closing");
                    }, 250);
                }

                // 프로젝트 추가

                async function addProject() {
                    const projectName = projectNameInput.value.trim();

                    if (!projectName) {
                        notificationManager.error(i18n.t("dashboard.notifications.enterName"));

                        return;
                    }

                    if (projects.some((p) => p.name === projectName)) {
                        notificationManager.error(i18n.t("dashboard.notifications.projectExists"));

                        return;
                    }

                    try {
                        const result = await window.localkeys.projects.create(projectName);

                        if (result.success) {
                            hideAddProjectModal();

                            await loadProjects();

                            notificationManager.success(i18n.t("dashboard.notifications.projectCreated", { name: projectName }));
                        } else {
                            notificationManager.error(i18n.t("dashboard.notifications.failedToCreate"));
                        }
                    } catch (error) {
                        notificationManager.error(i18n.t("dashboard.notifications.failedToCreate"));
                    }
                }

                // 검색

                function searchProjects() {
                    const query = searchInput.value.toLowerCase().trim();

                    if (!query) {
                        filteredProjects = projects;
                    } else {
                        filteredProjects = projects.filter((project) => project.name.toLowerCase().includes(query));
                    }

                    renderProjects();
                }

                function formatDate(dateString) {
                    const date = new Date(dateString);

                    const now = new Date();

                    const diffMs = now - date;

                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                    if (diffDays === 0) {
                        return i18n.t("dashboard.time.today");
                    } else if (diffDays === 1) {
                        return i18n.t("dashboard.time.yesterday");
                    } else if (diffDays < 7) {
                        return i18n.t("dashboard.time.daysAgo", { count: diffDays });
                    } else if (diffDays < 30) {
                        return i18n.t("dashboard.time.weeksAgo", { count: Math.floor(diffDays / 7) });
                    } else {
                        return date.toLocaleDateString();
                    }
                }

                // 이벤트 리스너

                searchInput.addEventListener("input", searchProjects);

                addProjectBtn.addEventListener("click", showAddProjectModal);

                settingsDropdownBtn.addEventListener("click", () => toggleDropdown("settings"));

                logsBtn.addEventListener("click", function () {
                    window.location.href = "logs.html";
                });

                lockBtn.addEventListener("click", async function () {
                    try {
                        await window.localkeys.vault.lock();
                    } catch (error) {
                        notificationManager.error(i18n.t("dashboard.notifications.lockError", { error: error.message }));
                    }
                });

                cancelAddProject.addEventListener("click", hideAddProjectModal);

                confirmAddProject.addEventListener("click", addProject);

                projectNameInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        addProject();
                    }
                });

                // 모달 외부 클릭 감지를 위한 변수

                let mouseDownTarget = null;

                // 마우스 다운 이벤트 추적

                document.addEventListener("mousedown", function (e) {
                    mouseDownTarget = e.target;
                });

                addProjectModal.addEventListener("click", function (e) {
                    // 클릭 시작과 끝 모두 모달 오버레이인 경우에만 닫기

                    if (mouseDownTarget === addProjectModal && e.target === addProjectModal) {
                        hideAddProjectModal();
                    }
                });

                // 마우스 업 이벤트 추적 - 클릭 해제도 밖에서 해야 함

                document.addEventListener("mouseup", function (e) {
                    // 클릭 시작이 모달 오버레이였지만 클릭 해제가 모달 외부인 경우 모달 닫기

                    if (mouseDownTarget === addProjectModal && e.target !== addProjectModal) {
                        mouseDownTarget = null; // 초기화

                        return;
                    }
                });

                // 드롭다운 토글 함수

                function toggleDropdown(id) {
                    const dropdown = document.getElementById(`dropdown-${id}`);

                    const allDropdowns = document.querySelectorAll(".dropdown-menu");

                    // 다른 드롭다운 모두 닫기

                    allDropdowns.forEach((d) => {
                        if (d !== dropdown) {
                            d.classList.add("hidden");
                        }
                    });

                    // 현재 드롭다운 토글

                    dropdown.classList.toggle("hidden");
                }

                // 외부 클릭 시 드롭다운 닫기

                document.addEventListener("click", function (e) {
                    if (!e.target.closest(".dropdown")) {
                        const allDropdowns = document.querySelectorAll(".dropdown-menu");

                        allDropdowns.forEach((d) => d.classList.add("hidden"));
                    }
                });

                // 자동 새로고침 설정 (10초마다)

                const autoRefreshInterval = setInterval(async () => {
                    if (document.visibilityState === "visible") {
                        await loadProjects();
                    }
                }, 10000);

                // 페이지가 보이지 않을 때는 자동 새로고침 중지

                document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === "hidden") {
                        clearInterval(autoRefreshInterval);
                    }
                });

                // CLI 버튼 상태 관리

                const setCliButtonState = (text, disabled, opacity, onclick) => {
                    installCliBtn.textContent = text;

                    installCliBtn.disabled = disabled;

                    installCliBtn.style.opacity = opacity;

                    installCliBtn.onclick = onclick;
                };

                // CLI 작업 처리 (설치/제거)

                async function handleCliAction(action) {
                    try {
                        const isInstalling = action === "install";

                        const loadingText = isInstalling ? i18n.t("dashboard.installing") : i18n.t("dashboard.uninstalling");

                        const apiMethod = isInstalling ? window.localkeys.cli.install : window.localkeys.cli.uninstall;

                        const successPrefix = isInstalling ? "installation" : "uninstallation";

                        setCliButtonState(loadingText, true, "0.6", null);

                        const result = await apiMethod();

                        if (result.success) {
                            notificationManager.success(result.message);

                            await checkCliStatus();
                        } else {
                            notificationManager.error(result.error);

                            setCliButtonState(isInstalling ? i18n.t("dashboard.installCli") : i18n.t("dashboard.uninstallCli"), false, "1", isInstalling ? installCli : uninstallCli);
                        }
                    } catch (error) {
                        const actionName = action === "install" ? "installation" : "uninstallation";

                        notificationManager.error(i18n.t("dashboard.notifications.cliInstallFailed", { action: actionName, error: error.message }));

                        setCliButtonState(action === "install" ? i18n.t("dashboard.installCli") : i18n.t("dashboard.uninstallCli"), false, "1", action === "install" ? installCli : uninstallCli);
                    }
                }

                // CLI 설치 상태 확인

                async function checkCliStatus() {
                    try {
                        const result = await window.localkeys.cli.check();

                        if (result.installed) {
                            setCliButtonState(i18n.t("dashboard.uninstallCli"), false, "1", () => handleCliAction("uninstall"));
                        } else {
                            setCliButtonState(i18n.t("dashboard.installCli"), false, "1", () => handleCliAction("install"));
                        }
                    } catch (error) {
                        setCliButtonState(i18n.t("dashboard.installCli"), false, "1", () => handleCliAction("install"));
                    }
                }

                // CLI 설치 함수

                const installCli = () => handleCliAction("install");

                // CLI 제거 함수

                const uninstallCli = () => {
                    if (confirm(i18n.t("dashboard.confirmUninstallCli"))) {
                        handleCliAction("uninstall");
                    }
                };

                // 초기 로드

                loadProjects();

                checkCliStatus();
            });
        </script>
    </body>
</html>
