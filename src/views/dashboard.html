<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LocalKeys</title>
        <link rel="stylesheet" href="../styles/common.css" />
    </head>
    <body>
        <div class="container">
            <div class="page-header dashboard-header">
                <h1 class="page-title dashboard-title">Projects</h1>
                <div class="header-actions">
                    <button class="btn" id="add-project-btn">Add Project</button>
                    <button class="btn btn-secondary" id="logs-btn">Logs</button>
                    <button class="btn btn-secondary" id="lock-btn">Lock</button>
                </div>
            </div>

            <!-- Í≤ÄÏÉâ Î∞î -->
            <div class="search-bar">
                <input type="text" class="search-input" id="search-input" placeholder="Search projects..." />
                <span class="search-icon">üîç</span>
            </div>

            <!-- ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù -->
            <div id="projects-container">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä Î™®Îã¨ -->
        <div id="add-project-modal" class="modal-overlay hidden">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Project</h3>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label for="project-name">Project Name</label>
                        <input type="text" id="project-name" placeholder="Enter project name" autocomplete="off" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-add-project">Cancel</button>
                    <button class="btn" id="confirm-add-project">Add Project</button>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const projectsContainer = document.getElementById("projects-container");
                const searchInput = document.getElementById("search-input");
                const addProjectBtn = document.getElementById("add-project-btn");
                const logsBtn = document.getElementById("logs-btn");
                const lockBtn = document.getElementById("lock-btn");
                const addProjectModal = document.getElementById("add-project-modal");
                const projectNameInput = document.getElementById("project-name");
                const cancelAddProject = document.getElementById("cancel-add-project");
                const confirmAddProject = document.getElementById("confirm-add-project");

                let projects = [];
                let filteredProjects = [];

                // ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú
                async function loadProjects() {
                    try {
                        const result = await window.localkeys.projects.get();

                        if (result.success) {
                            projects = result.data;
                            filteredProjects = projects;
                            renderProjects();
                        } else {
                            showError("Failed to load projects");
                        }
                    } catch (error) {
                        showError(`Error loading projects: ${error.message}`);
                    }
                }

                // ÌîÑÎ°úÏ†ùÌä∏ Î†åÎçîÎßÅ
                function renderProjects() {
                    if (filteredProjects.length === 0) {
                        projectsContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìÅ</div>
              <div class="empty-state-title">No projects found</div>
              <div class="empty-state-description">
                ${projects.length === 0 ? "Create your first project to start managing your secrets securely." : "No projects match your search criteria."}
              </div>
              ${projects.length === 0 ? '<button class="btn" onclick="showAddProjectModal()">Create Project</button>' : ""}
            </div>
          `;
                        return;
                    }

                    const projectsHTML = filteredProjects
                        .map(
                            (project) => `
          <div class="project-card" onclick="openProject('${project.name}')">
            <div class="project-name">${escapeHtml(project.name)}</div>
            <div class="project-date">Updated ${formatDate(project.updatedAt)}</div>
            <div class="project-stats">
              <div class="secret-count">${project.secretCount} secrets</div>
              <div class="project-actions">
                <button class="btn btn-secondary" onclick="event.stopPropagation(); deleteProject('${project.name}')">Delete</button>
              </div>
            </div>
          </div>
        `
                        )
                        .join("");

                    projectsContainer.innerHTML = `<div class="projects-grid">${projectsHTML}</div>`;
                }

                // ÌîÑÎ°úÏ†ùÌä∏ Ïó¥Í∏∞
                function openProject(projectName) {
                    window.location.href = `project.html?name=${encodeURIComponent(projectName)}`;
                }

                // ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†ú
                async function deleteProject(projectName) {
                    if (!confirm(`Are you sure you want to delete project "${projectName}"? This will also delete all secrets in this project.`)) {
                        return;
                    }

                    try {
                        const result = await window.localkeys.projects.delete(projectName);

                        if (result.success) {
                            await loadProjects();
                            showSuccess(`Project "${projectName}" deleted successfully`);
                        } else {
                            showError(`Failed to delete project: ${result.error}`);
                        }
                    } catch (error) {
                        showError(`Error deleting project: ${error.message}`);
                    }
                }

                // ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä Î™®Îã¨ ÌëúÏãú
                function showAddProjectModal() {
                    addProjectModal.classList.remove("hidden");
                    projectNameInput.value = "";

                    // Îã§Ïùå ÌîÑÎ†àÏûÑÏóêÏÑú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
                    requestAnimationFrame(() => {
                        addProjectModal.classList.add("show");
                    });

                    projectNameInput.focus();
                }

                // ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä Î™®Îã¨ Ïà®Í∏∞Í∏∞
                function hideAddProjectModal() {
                    addProjectModal.classList.remove("show");
                    addProjectModal.classList.add("closing");

                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ÌõÑ Î™®Îã¨ ÏôÑÏ†ÑÌûà Ïà®Í∏∞Í∏∞
                    setTimeout(() => {
                        addProjectModal.classList.add("hidden");
                        addProjectModal.classList.remove("closing");
                    }, 250);
                }

                // ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä
                async function addProject() {
                    const projectName = projectNameInput.value.trim();

                    if (!projectName) {
                        showError("Please enter a project name");
                        return;
                    }

                    if (projects.some((p) => p.name === projectName)) {
                        showError("A project with this name already exists");
                        return;
                    }

                    try {
                        const result = await window.localkeys.projects.create(projectName);

                        if (result.success) {
                            hideAddProjectModal();
                            await loadProjects();
                            showSuccess(`Project "${projectName}" created successfully`);
                        } else {
                            showError(`Failed to create project: ${result.error}`);
                        }
                    } catch (error) {
                        showError(`Error creating project: ${error.message}`);
                    }
                }

                // Í≤ÄÏÉâ
                function searchProjects() {
                    const query = searchInput.value.toLowerCase().trim();

                    if (!query) {
                        filteredProjects = projects;
                    } else {
                        filteredProjects = projects.filter((project) => project.name.toLowerCase().includes(query));
                    }

                    renderProjects();
                }

                // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
                function escapeHtml(text) {
                    const div = document.createElement("div");
                    div.textContent = text;
                    return div.innerHTML;
                }

                function formatDate(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                    if (diffDays === 0) {
                        return "today";
                    } else if (diffDays === 1) {
                        return "yesterday";
                    } else if (diffDays < 7) {
                        return `${diffDays} days ago`;
                    } else if (diffDays < 30) {
                        return `${Math.floor(diffDays / 7)} weeks ago`;
                    } else {
                        return date.toLocaleDateString();
                    }
                }

                function showSuccess(message) {
                    showMessage(message, "success");
                }

                function showError(message) {
                    showMessage(message, "error");
                }

                function showMessage(message, type) {
                    // Í∏∞Ï°¥ Î©îÏãúÏßÄÎì§Ïù¥ ÏûàÎã§Î©¥ Ï†úÍ±∞
                    const existingMessages = document.querySelectorAll('.message');
                    existingMessages.forEach(msg => {
                        if (msg.parentNode) {
                            msg.remove();
                        }
                    });

                    const messageEl = document.createElement("div");
                    messageEl.className = `message message-${type}`;

                    // ÏïÑÏù¥ÏΩò Í≤∞Ï†ï
                    let icon = '‚úì';
                    if (type === 'error') icon = '‚úï';
                    else if (type === 'warning') icon = '‚ö†';

                    messageEl.innerHTML = `
                        <div class="message-content">
                            <div class="message-header">
                                <div class="message-left">
                                    <div class="message-icon">${icon}</div>
                                    <div class="message-text">${escapeHtml(message)}</div>
                                </div>
                            </div>
                            <button class="message-close">√ó</button>
                        </div>
                    `;

                    document.body.appendChild(messageEl);

                    // Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ ÏúÑÌï¥ ÏïΩÍ∞ÑÏùò ÎîúÎ†àÏù¥ ÌõÑ show ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
                    setTimeout(() => {
                        messageEl.classList.add('show');
                    }, 10);

                    // Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
                    const closeBtn = messageEl.querySelector('.message-close');
                    closeBtn.addEventListener('click', () => {
                        hideMessage(messageEl);
                    });

                    // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÏïåÎ¶º Ï†ÄÏû•
                    saveNotificationToStorage(message, type);
                }

                function hideMessage(messageEl) {
                    messageEl.classList.add('hide');
                    // ÏïåÎ¶ºÏùÑ Îã´ÏùÑ Îïå Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Ï†úÍ±∞
                    localStorage.removeItem('localkeys_notifications');

                    // Ïï†ÎãàÎ©îÏù¥ÏÖòÏù¥ ÎÅùÎÇú ÌõÑ DOMÏóêÏÑú Ï†úÍ±∞
                    setTimeout(() => {
                        if (document.body.contains(messageEl)) {
                            document.body.removeChild(messageEl);
                        }
                    }, 300);
                }

                // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•Îêú ÏïåÎ¶º Î∂àÎü¨Ïò§Í∏∞
                function loadStoredNotifications() {
                    const stored = localStorage.getItem('localkeys_notifications');
                    if (stored) {
                        try {
                            const notifications = JSON.parse(stored);
                            if (notifications && notifications.length > 0) {
                                // Í∞ÄÏû• ÏµúÍ∑º ÏïåÎ¶ºÎßå ÌëúÏãú
                                const latestNotification = notifications[notifications.length - 1];
                                showMessageStatic(latestNotification.message, latestNotification.type);

                                // ÌëúÏãú ÌõÑÏóêÎèÑ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ïú†ÏßÄ (ÏÇ¨Ïö©ÏûêÍ∞Ä Îã´ÏùÑ Îïå Ï†úÍ±∞)
                            }
                        } catch (error) {
                            console.error('Failed to load stored notifications:', error);
                            localStorage.removeItem('localkeys_notifications');
                        }
                    }
                }

                // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏóÜÏù¥ ÏïåÎ¶º ÌëúÏãú (Ï†ÄÏû•Îêú ÏïåÎ¶ºÏö©)
                function showMessageStatic(message, type) {
                    // Í∏∞Ï°¥ Î©îÏãúÏßÄÎì§Ïù¥ ÏûàÎã§Î©¥ Ï†úÍ±∞
                    const existingMessages = document.querySelectorAll('.message');
                    existingMessages.forEach(msg => {
                        if (msg.parentNode) {
                            msg.remove();
                        }
                    });

                    const messageEl = document.createElement("div");
                    messageEl.className = `message message-${type}`;

                    // ÏïÑÏù¥ÏΩò Í≤∞Ï†ï
                    let icon = '‚úì';
                    if (type === 'error') icon = '‚úï';
                    else if (type === 'warning') icon = '‚ö†';

                    messageEl.innerHTML = `
                        <div class="message-content">
                            <div class="message-header">
                                <div class="message-left">
                                    <div class="message-icon">${icon}</div>
                                    <div class="message-text">${escapeHtml(message)}</div>
                                </div>
                            </div>
                            <button class="message-close">√ó</button>
                        </div>
                    `;

                    document.body.appendChild(messageEl);

                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏóÜÏù¥ Î∞îÎ°ú ÌëúÏãú
                    messageEl.style.right = '20px';
                    messageEl.style.bottom = '20px';
                    messageEl.style.opacity = '1';

                    // Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
                    const closeBtn = messageEl.querySelector('.message-close');
                    closeBtn.addEventListener('click', () => {
                        hideMessage(messageEl);
                    });
                }

                // ÏïåÎ¶ºÏùÑ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
                function saveNotificationToStorage(message, type) {
                    try {
                        const stored = localStorage.getItem('localkeys_notifications');
                        const notifications = stored ? JSON.parse(stored) : [];

                        // ÏÉà ÏïåÎ¶º Ï∂îÍ∞Ä (ÏµúÎåÄ 5Í∞úÍπåÏßÄ Ïú†ÏßÄ)
                        notifications.push({ message, type, timestamp: Date.now() });
                        if (notifications.length > 5) {
                            notifications.splice(0, notifications.length - 5);
                        }

                        localStorage.setItem('localkeys_notifications', JSON.stringify(notifications));
                    } catch (error) {
                        console.error('Failed to save notification:', error);
                    }
                }

                // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
                function escapeHtml(text) {
                    const div = document.createElement("div");
                    div.textContent = text;
                    return div.innerHTML;
                }

                // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                searchInput.addEventListener("input", searchProjects);
                addProjectBtn.addEventListener("click", showAddProjectModal);

                logsBtn.addEventListener("click", function () {
                    window.location.href = "logs.html";
                });

                lockBtn.addEventListener("click", async function () {
                    try {
                        await window.localkeys.vault.lock();
                    } catch (error) {
                        showError(`Error locking vault: ${error.message}`);
                    }
                });

                cancelAddProject.addEventListener("click", hideAddProjectModal);
                confirmAddProject.addEventListener("click", addProject);

                projectNameInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        addProject();
                    }
                });

                // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Í∞êÏßÄÎ•º ÏúÑÌïú Î≥ÄÏàò
                let mouseDownTarget = null;

                // ÎßàÏö∞Ïä§ Îã§Ïö¥ Ïù¥Î≤§Ìä∏ Ï∂îÏ†Å
                document.addEventListener("mousedown", function (e) {
                    mouseDownTarget = e.target;
                });

                addProjectModal.addEventListener("click", function (e) {
                    // ÌÅ¥Î¶≠ ÏãúÏûëÍ≥º ÎÅù Î™®Îëê Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥Ïù∏ Í≤ΩÏö∞ÏóêÎßå Îã´Í∏∞
                    if (mouseDownTarget === addProjectModal && e.target === addProjectModal) {
                        hideAddProjectModal();
                    }
                });

                // ÎßàÏö∞Ïä§ ÏóÖ Ïù¥Î≤§Ìä∏ Ï∂îÏ†Å - ÌÅ¥Î¶≠ Ìï¥Ï†úÎèÑ Î∞ñÏóêÏÑú Ìï¥Ïïº Ìï®
                document.addEventListener("mouseup", function (e) {
                    // ÌÅ¥Î¶≠ ÏãúÏûëÏù¥ Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥ÏòÄÏßÄÎßå ÌÅ¥Î¶≠ Ìï¥Ï†úÍ∞Ä Î™®Îã¨ Ïô∏Î∂ÄÏù∏ Í≤ΩÏö∞ Î™®Îã¨ Îã´Í∏∞
                    if (mouseDownTarget === addProjectModal && e.target !== addProjectModal) {
                        mouseDownTarget = null; // Ï¥àÍ∏∞Ìôî
                        return;
                    }
                });

                // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù (HTML onclickÏóêÏÑú ÏÇ¨Ïö©)
                window.openProject = openProject;
                window.deleteProject = deleteProject;
                window.showAddProjectModal = showAddProjectModal;

                // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏÑ§Ï†ï (10Ï¥àÎßàÎã§)
                const autoRefreshInterval = setInterval(async () => {
                    if (document.visibilityState === "visible") {
                        await loadProjects();
                    }
                }, 10000);

                // ÌéòÏù¥ÏßÄÍ∞Ä Î≥¥Ïù¥ÏßÄ ÏïäÏùÑ ÎïåÎäî ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ï§ëÏßÄ
                document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === "hidden") {
                        clearInterval(autoRefreshInterval);
                    }
                });

                // Ï¥àÍ∏∞ Î°úÎìú
                loadProjects();
                // Ï†ÄÏû•Îêú ÏïåÎ¶º Î∂àÎü¨Ïò§Í∏∞
                loadStoredNotifications();
            });
        </script>
    </body>
</html>
