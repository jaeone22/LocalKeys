<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LocalKeys</title>
        <link rel="stylesheet" href="../styles/common.css" />
    </head>
    <body>
        <div class="container">
            <div class="page-header logs-header">
                <div class="page-title">
                    <button class="back-btn" id="back-btn">
                        <span class="lk-icon lk-icon-arrow-left" aria-hidden="true"></span>
                    </button>
                    <span id="title">Access Logs</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-danger" id="clear-logs-btn">Clear All Logs</button>
                </div>
            </div>

            <!-- 로그 목록 -->
            <div class="logs-container" id="logs-container">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <script src="../modules/i18n-helper.js"></script>
        <script src="../modules/notification.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", async function () {
                // 다국어 초기화
                await i18n.init();

                // UI 번역 적용
                document.getElementById("title").textContent = i18n.t("logs.title");
                document.getElementById("clear-logs-btn").textContent = i18n.t("logs.clearAll");
                const logsContainer = document.getElementById("logs-container");
                const backBtn = document.getElementById("back-btn");
                const clearLogsBtn = document.getElementById("clear-logs-btn");

                let allLogs = [];
                let displayedLogsCount = 0;
                const logsPerLoad = 50;
                let isLoading = false;
                let hasMoreLogs = true;

                // 로그 로드
                async function loadLogs() {
                    try {
                        const result = await window.localkeys.logs.get();

                        if (result.success) {
                            allLogs = result.data.reverse(); // 최신 로그부터 표시
                            displayedLogsCount = 0;
                            hasMoreLogs = true;
                            renderLogs();
                        } else {
                            notificationManager.error(i18n.t("logs.notifications.failedToLoad"));
                        }
                    } catch (error) {
                        notificationManager.error(i18n.t("logs.notifications.failedToLoad"));
                    }
                }

                // 추가 로그 로드 (무한 스크롤)
                function loadMoreLogs() {
                    if (isLoading || !hasMoreLogs) return;

                    isLoading = true;

                    setTimeout(() => {
                        const startIndex = displayedLogsCount;
                        const endIndex = Math.min(startIndex + logsPerLoad, allLogs.length);

                        if (startIndex >= allLogs.length) {
                            hasMoreLogs = false;
                            isLoading = false;
                            return;
                        }

                        if (displayedLogsCount === 0) {
                            logsContainer.innerHTML = ""; // Clear loading spinner
                        }

                        const fragment = document.createDocumentFragment();
                        allLogs.slice(startIndex, endIndex).forEach((log) => {
                            fragment.appendChild(createLogElement(log));
                        });
                        logsContainer.appendChild(fragment);

                        displayedLogsCount = endIndex;
                        hasMoreLogs = endIndex < allLogs.length;
                        isLoading = false;
                    }, 100);
                }

                function createLogElement(log) {
                    const logItem = document.createElement("div");
                    logItem.className = "log-item";

                    const logHeader = document.createElement("div");
                    logHeader.className = "log-header";

                    const timestampDiv = document.createElement("div");
                    timestampDiv.className = "log-timestamp";
                    timestampDiv.textContent = formatTimestamp(log.timestamp);

                    const typeDiv = document.createElement("div");
                    typeDiv.className = `log-type ${log.category}`;
                    typeDiv.textContent = log.category;

                    logHeader.appendChild(timestampDiv);
                    logHeader.appendChild(typeDiv);

                    const messageDiv = document.createElement("div");
                    messageDiv.className = "log-message";
                    messageDiv.textContent = log.message;

                    logItem.appendChild(logHeader);
                    logItem.appendChild(messageDiv);

                    return logItem;
                }

                // 로그 렌더링
                function renderLogs() {
                    logsContainer.innerHTML = ""; // 초기화

                    if (allLogs.length === 0) {
                        const emptyState = document.createElement("div");
                        emptyState.className = "empty-state";

                        const icon = document.createElement("div");
                        icon.className = "empty-state-icon lk-icon lk-icon-clipboard lk-icon-xl";
                        icon.setAttribute("aria-hidden", "true");

                        const title = document.createElement("div");
                        title.className = "empty-state-title";
                        title.textContent = i18n.t("logs.emptyState.title");

                        const description = document.createElement("div");
                        description.className = "empty-state-description";
                        description.textContent = i18n.t("logs.emptyState.description");

                        emptyState.appendChild(icon);
                        emptyState.appendChild(title);
                        emptyState.appendChild(description);

                        logsContainer.appendChild(emptyState);
                        return;
                    }

                    displayedLogsCount = 0;
                    loadMoreLogs(); // 첫 50개 로드
                }

                // 타임스탬프 포맷
                function formatTimestamp(timestamp) {
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMinutes = Math.floor(diffMs / (1000 * 60));
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                    if (diffMinutes < 1) {
                        return i18n.t("logs.timeAgo.justNow");
                    } else if (diffMinutes < 60) {
                        return diffMinutes === 1 ? i18n.t("logs.timeAgo.minuteAgo", { count: diffMinutes }) : i18n.t("logs.timeAgo.minutesAgo", { count: diffMinutes });
                    } else if (diffHours < 24) {
                        return diffHours === 1 ? i18n.t("logs.timeAgo.hourAgo", { count: diffHours }) : i18n.t("logs.timeAgo.hoursAgo", { count: diffHours });
                    } else if (diffDays < 7) {
                        return diffDays === 1 ? i18n.t("logs.timeAgo.dayAgo", { count: diffDays }) : i18n.t("logs.timeAgo.daysAgo", { count: diffDays });
                    } else {
                        return date.toLocaleString();
                    }
                }

                // 이벤트 리스너 - 무한 스크롤
                logsContainer.addEventListener("scroll", function () {
                    if (logsContainer.scrollTop + logsContainer.clientHeight >= logsContainer.scrollHeight - 50) {
                        loadMoreLogs();
                    }
                });

                backBtn.addEventListener("click", function () {
                    window.location.href = "dashboard.html";
                });

                // 로그 삭제 버튼 클릭
                clearLogsBtn.addEventListener("click", async function () {
                    if (confirm(i18n.t("logs.clearConfirm"))) {
                        try {
                            const result = await window.localkeys.logs.clear();
                            if (result.success) {
                                notificationManager.success(i18n.t("logs.notifications.cleared"));
                                allLogs = [];
                                renderLogs();
                            } else {
                                notificationManager.error(i18n.t("logs.notifications.failedToClear"));
                            }
                        } catch (error) {
                            notificationManager.error(i18n.t("logs.notifications.failedToClear"));
                        }
                    }
                });

                // 자동 새로고침 설정 (15초마다)
                const autoRefreshInterval = setInterval(async () => {
                    if (document.visibilityState === "visible") {
                        await loadLogs();
                    }
                }, 15000);

                // 페이지가 보이지 않을 때는 자동 새로고침 중지
                document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === "hidden") {
                        clearInterval(autoRefreshInterval);
                    }
                });

                // 초기 로드
                loadLogs();
            });
        </script>
    </body>
</html>
