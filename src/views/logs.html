<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LocalKeys</title>
        <link rel="stylesheet" href="../styles/common.css" />
    </head>
    <body>
        <div class="container">
            <div class="page-header logs-header">
                <div class="page-title logs-title">
                    <button class="back-btn" id="back-btn">‚Üê</button>
                    Access Logs
                </div>
                <div class="header-actions"></div>
            </div>

            <!-- Î°úÍ∑∏ Î™©Î°ù -->
            <div class="logs-container" id="logs-container">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const logsContainer = document.getElementById("logs-container");
                const backBtn = document.getElementById("back-btn");

                let allLogs = [];
                let displayedLogsCount = 0;
                const logsPerLoad = 50;
                let isLoading = false;
                let hasMoreLogs = true;

                // Î°úÍ∑∏ Î°úÎìú
                async function loadLogs() {
                    try {
                        const result = await window.localkeys.logs.get();

                        if (result.success) {
                            allLogs = result.data.reverse(); // ÏµúÏã† Î°úÍ∑∏Î∂ÄÌÑ∞ ÌëúÏãú
                            displayedLogsCount = 0;
                            hasMoreLogs = true;
                            renderLogs();
                        } else {
                            showError("Failed to load logs");
                        }
                    } catch (error) {
                        showError(`Error loading logs: ${error.message}`);
                    }
                }

                // Ï∂îÍ∞Ä Î°úÍ∑∏ Î°úÎìú (Î¨¥Ìïú Ïä§ÌÅ¨Î°§)
                function loadMoreLogs() {
                    if (isLoading || !hasMoreLogs) return;

                    isLoading = true;

                    setTimeout(() => {
                        const startIndex = displayedLogsCount;
                        const endIndex = Math.min(startIndex + logsPerLoad, allLogs.length);

                        if (startIndex >= allLogs.length) {
                            hasMoreLogs = false;
                            isLoading = false;
                            return;
                        }

                        const newLogs = allLogs.slice(startIndex, endIndex);
                        const logsHTML = newLogs
                            .map(
                                (log) => `
                  <div class="log-item">
                    <div class="log-header">
                      <div class="log-timestamp">${formatTimestamp(log.timestamp)}</div>
                      <div class="log-type ${log.category}">${log.category}</div>
                    </div>
                    <div class="log-message">${escapeHtml(log.message)}</div>
                  </div>
                `
                            )
                            .join("");

                        if (displayedLogsCount === 0) {
                            logsContainer.innerHTML = logsHTML;
                        } else {
                            logsContainer.innerHTML += logsHTML;
                        }

                        displayedLogsCount = endIndex;
                        hasMoreLogs = endIndex < allLogs.length;
                        isLoading = false;
                    }, 100);
                }

                // Î°úÍ∑∏ Î†åÎçîÎßÅ
                function renderLogs() {
                    if (allLogs.length === 0) {
                        logsContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìã</div>
              <div class="empty-state-title">No logs found</div>
              <div class="empty-state-description">
                No logs have been recorded yet.
              </div>
            </div>
          `;
                        return;
                    }

                    logsContainer.innerHTML = ""; // Ï¥àÍ∏∞Ìôî
                    displayedLogsCount = 0;
                    loadMoreLogs(); // Ï≤´ 50Í∞ú Î°úÎìú
                }

                // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ìè¨Îß∑
                function formatTimestamp(timestamp) {
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMinutes = Math.floor(diffMs / (1000 * 60));
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                    if (diffMinutes < 1) {
                        return "Just now";
                    } else if (diffMinutes < 60) {
                        return `${diffMinutes} minute${diffMinutes > 1 ? "s" : ""} ago`;
                    } else if (diffHours < 24) {
                        return `${diffHours} hour${diffHours > 1 ? "s" : ""} ago`;
                    } else if (diffDays < 7) {
                        return `${diffDays} day${diffDays > 1 ? "s" : ""} ago`;
                    } else {
                        return date.toLocaleString();
                    }
                }

                // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
                function escapeHtml(text) {
                    const div = document.createElement("div");
                    div.textContent = text;
                    return div.innerHTML;
                }

                function showError(message) {
                    showMessage(message, "error");
                }

                function showMessage(message, type) {
                    // Í∏∞Ï°¥ Î©îÏãúÏßÄÎì§Ïù¥ ÏûàÎã§Î©¥ Ï†úÍ±∞
                    const existingMessages = document.querySelectorAll('.message');
                    existingMessages.forEach(msg => {
                        if (msg.parentNode) {
                            msg.remove();
                        }
                    });

                    const messageEl = document.createElement("div");
                    messageEl.className = `message message-${type}`;

                    // ÏïÑÏù¥ÏΩò Í≤∞Ï†ï
                    let icon = '‚úì';
                    if (type === 'error') icon = '‚úï';
                    else if (type === 'warning') icon = '‚ö†';

                    messageEl.innerHTML = `
                        <div class="message-content">
                            <div class="message-header">
                                <div class="message-left">
                                    <div class="message-icon">${icon}</div>
                                    <div class="message-text">${escapeHtml(message)}</div>
                                </div>
                            </div>
                            <button class="message-close">√ó</button>
                        </div>
                    `;

                    document.body.appendChild(messageEl);

                    // Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ ÏúÑÌï¥ ÏïΩÍ∞ÑÏùò ÎîúÎ†àÏù¥ ÌõÑ show ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
                    setTimeout(() => {
                        messageEl.classList.add('show');
                    }, 10);

                    // Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
                    const closeBtn = messageEl.querySelector('.message-close');
                    closeBtn.addEventListener('click', () => {
                        hideMessage(messageEl);
                    });

                    // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÏïåÎ¶º Ï†ÄÏû•
                    saveNotificationToStorage(message, type);
                }

                function hideMessage(messageEl) {
                    messageEl.classList.add('hide');
                    // ÏïåÎ¶ºÏùÑ Îã´ÏùÑ Îïå Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Ï†úÍ±∞
                    localStorage.removeItem('localkeys_notifications');

                    // Ïï†ÎãàÎ©îÏù¥ÏÖòÏù¥ ÎÅùÎÇú ÌõÑ DOMÏóêÏÑú Ï†úÍ±∞
                    setTimeout(() => {
                        if (document.body.contains(messageEl)) {
                            document.body.removeChild(messageEl);
                        }
                    }, 300);
                }

                // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•Îêú ÏïåÎ¶º Î∂àÎü¨Ïò§Í∏∞
                function loadStoredNotifications() {
                    const stored = localStorage.getItem('localkeys_notifications');
                    if (stored) {
                        try {
                            const notifications = JSON.parse(stored);
                            if (notifications && notifications.length > 0) {
                                // Í∞ÄÏû• ÏµúÍ∑º ÏïåÎ¶ºÎßå ÌëúÏãú
                                const latestNotification = notifications[notifications.length - 1];
                                showMessageStatic(latestNotification.message, latestNotification.type);

                                // ÌëúÏãú ÌõÑÏóêÎèÑ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ïú†ÏßÄ (ÏÇ¨Ïö©ÏûêÍ∞Ä Îã´ÏùÑ Îïå Ï†úÍ±∞)
                            }
                        } catch (error) {
                            console.error('Failed to load stored notifications:', error);
                            localStorage.removeItem('localkeys_notifications');
                        }
                    }
                }

                // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏóÜÏù¥ ÏïåÎ¶º ÌëúÏãú (Ï†ÄÏû•Îêú ÏïåÎ¶ºÏö©)
                function showMessageStatic(message, type) {
                    // Í∏∞Ï°¥ Î©îÏãúÏßÄÎì§Ïù¥ ÏûàÎã§Î©¥ Ï†úÍ±∞
                    const existingMessages = document.querySelectorAll('.message');
                    existingMessages.forEach(msg => {
                        if (msg.parentNode) {
                            msg.remove();
                        }
                    });

                    const messageEl = document.createElement("div");
                    messageEl.className = `message message-${type}`;

                    // ÏïÑÏù¥ÏΩò Í≤∞Ï†ï
                    let icon = '‚úì';
                    if (type === 'error') icon = '‚úï';
                    else if (type === 'warning') icon = '‚ö†';

                    messageEl.innerHTML = `
                        <div class="message-content">
                            <div class="message-header">
                                <div class="message-left">
                                    <div class="message-icon">${icon}</div>
                                    <div class="message-text">${escapeHtml(message)}</div>
                                </div>
                            </div>
                            <button class="message-close">√ó</button>
                        </div>
                    `;

                    document.body.appendChild(messageEl);

                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏóÜÏù¥ Î∞îÎ°ú ÌëúÏãú
                    messageEl.style.right = '20px';
                    messageEl.style.bottom = '20px';
                    messageEl.style.opacity = '1';

                    // Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
                    const closeBtn = messageEl.querySelector('.message-close');
                    closeBtn.addEventListener('click', () => {
                        hideMessage(messageEl);
                    });
                }

                // ÏïåÎ¶ºÏùÑ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
                function saveNotificationToStorage(message, type) {
                    try {
                        const stored = localStorage.getItem('localkeys_notifications');
                        const notifications = stored ? JSON.parse(stored) : [];

                        // ÏÉà ÏïåÎ¶º Ï∂îÍ∞Ä (ÏµúÎåÄ 5Í∞úÍπåÏßÄ Ïú†ÏßÄ)
                        notifications.push({ message, type, timestamp: Date.now() });
                        if (notifications.length > 5) {
                            notifications.splice(0, notifications.length - 5);
                        }

                        localStorage.setItem('localkeys_notifications', JSON.stringify(notifications));
                    } catch (error) {
                        console.error('Failed to save notification:', error);
                    }
                }

                // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà - Î¨¥Ìïú Ïä§ÌÅ¨Î°§
                logsContainer.addEventListener("scroll", function () {
                    if (logsContainer.scrollTop + logsContainer.clientHeight >= logsContainer.scrollHeight - 50) {
                        loadMoreLogs();
                    }
                });

                backBtn.addEventListener("click", function () {
                    window.location.href = "dashboard.html";
                });

                // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏÑ§Ï†ï (15Ï¥àÎßàÎã§)
                const autoRefreshInterval = setInterval(async () => {
                    if (document.visibilityState === "visible") {
                        await loadLogs();
                    }
                }, 15000);

                // ÌéòÏù¥ÏßÄÍ∞Ä Î≥¥Ïù¥ÏßÄ ÏïäÏùÑ ÎïåÎäî ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ï§ëÏßÄ
                document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === "hidden") {
                        clearInterval(autoRefreshInterval);
                    }
                });

                // Ï¥àÍ∏∞ Î°úÎìú
                loadLogs();
                // Ï†ÄÏû•Îêú ÏïåÎ¶º Î∂àÎü¨Ïò§Í∏∞
                loadStoredNotifications();
            });
        </script>
    </body>
</html>
