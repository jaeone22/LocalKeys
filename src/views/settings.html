<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LocalKeys</title>
        <link rel="stylesheet" href="../styles/common.css" />
    </head>
    <body>
        <div class="container">
            <div class="page-header settings-header">
                <div class="page-title">
                    <button class="back-btn" id="back-btn">
                        <span class="lk-icon lk-icon-arrow-left" aria-hidden="true"></span>
                    </button>
                    <span id="title">Settings</span>
                </div>
            </div>

            <!-- 설정 목록 -->
            <div class="settings-container" id="settings-container">
                <div class="settings-section">
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <span class="settings-item-label" id="label-language">Language</span>
                            <span class="settings-item-description" id="desc-language">Choose the display language</span>
                        </div>
                        <select id="language-select" class="filter-select">
                            <option value="system" id="lang-opt-system">System</option>
                            <option value="en" id="lang-opt-en">English</option>
                            <option value="ko" id="lang-opt-ko">Korean</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <span class="settings-item-label" id="label-check-updates">Check for updates</span>
                            <span class="settings-item-description" id="desc-check-updates">Automatically check for new versions on startup</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="check-updates-toggle" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <span class="settings-item-label" id="label-show-statistics">Show Statistics</span>
                            <span class="settings-item-description" id="desc-show-statistics">Display statistics on dashboard</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="show-statistics-toggle" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- 자동 잠금 -->
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <span class="settings-item-label" id="label-auto-lock">Auto Lock</span>
                            <span class="settings-item-description" id="desc-auto-lock">Automatically lock vault after system idle time</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="auto-lock-toggle" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item" id="auto-lock-timeout-item">
                        <div class="settings-item-info">
                            <span class="settings-item-label" id="label-auto-lock-timeout">Auto Lock Timeout (minutes)</span>
                        </div>
                        <input type="number" id="auto-lock-timeout-input" class="settings-input" min="1" max="1440" value="30" />
                    </div>

                    <!-- 화면 캡처 방지 -->
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <span class="settings-item-label" id="label-screen-capture">Screen Capture Protection</span>
                            <span class="settings-item-description" id="desc-screen-capture">Prevent screenshots and screen recording</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="screen-capture-toggle" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <script src="../modules/i18n-helper.js"></script>
        <script src="../modules/notification.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", async function () {
                // 다국어 초기화
                await i18n.init();

                // UI 번역 적용
                document.getElementById("title").textContent = i18n.t("settings.title");
                document.getElementById("label-language").textContent = i18n.t("settings.language");
                document.getElementById("desc-language").textContent = i18n.t("settings.languageDesc");
                document.getElementById("lang-opt-system").textContent = i18n.t("settings.languageOptions.system");
                document.getElementById("lang-opt-en").textContent = i18n.t("settings.languageOptions.en");
                document.getElementById("lang-opt-ko").textContent = i18n.t("settings.languageOptions.ko");
                document.getElementById("label-check-updates").textContent = i18n.t("settings.checkForUpdates");
                document.getElementById("desc-check-updates").textContent = i18n.t("settings.checkForUpdatesDesc");
                document.getElementById("label-show-statistics").textContent = i18n.t("settings.showStatistics");
                document.getElementById("desc-show-statistics").textContent = i18n.t("settings.showStatisticsDesc");

                // 보안 설정 번역
                document.getElementById("label-auto-lock").textContent = i18n.t("settings.autoLock");
                document.getElementById("desc-auto-lock").textContent = i18n.t("settings.autoLockDesc");
                document.getElementById("label-auto-lock-timeout").textContent = i18n.t("settings.autoLockTimeout");
                document.getElementById("label-screen-capture").textContent = i18n.t("settings.screenCaptureProtection");
                document.getElementById("desc-screen-capture").textContent = i18n.t("settings.screenCaptureProtectionDesc");

                const backBtn = document.getElementById("back-btn");
                const checkUpdatesToggle = document.getElementById("check-updates-toggle");
                const showStatisticsToggle = document.getElementById("show-statistics-toggle");
                const languageSelect = document.getElementById("language-select");

                // 보안 설정 요소
                const autoLockToggle = document.getElementById("auto-lock-toggle");
                const autoLockTimeoutInput = document.getElementById("auto-lock-timeout-input");
                const autoLockTimeoutItem = document.getElementById("auto-lock-timeout-item");
                const screenCaptureToggle = document.getElementById("screen-capture-toggle");

                // 타임아웃 입력 필드 표시/숨김
                function updateTimeoutVisibility() {
                    autoLockTimeoutItem.style.display = autoLockToggle.checked ? "flex" : "none";
                }

                // 설정 로드
                async function loadSettings() {
                    try {
                        const settings = await window.localkeys.settings.get();
                        checkUpdatesToggle.checked = settings.checkForUpdates;
                        showStatisticsToggle.checked = settings.showStatistics !== false; // 기본값 true
                        languageSelect.value = settings.locale || "system";

                        // 보안 설정 로드
                        autoLockToggle.checked = settings.autoLock?.enabled !== false; // 기본값 true
                        autoLockTimeoutInput.value = settings.autoLock?.timeout || 30;
                        screenCaptureToggle.checked = settings.screenCaptureProtection !== false; // 기본값 true

                        updateTimeoutVisibility();
                    } catch (error) {
                        notificationManager.error(i18n.t("settings.notifications.failedToLoad"));
                    }
                }

                // 설정 저장
                async function saveSettings() {
                    try {
                        const settings = {
                            checkForUpdates: checkUpdatesToggle.checked,
                            showStatistics: showStatisticsToggle.checked,
                            locale: languageSelect.value,
                            autoLock: {
                                enabled: autoLockToggle.checked,
                                timeout: parseInt(autoLockTimeoutInput.value) || 30,
                            },
                            screenCaptureProtection: screenCaptureToggle.checked,
                        };

                        const result = await window.localkeys.settings.set(settings);

                        if (result.success) {
                            notificationManager.success(i18n.t("settings.notifications.saved"));
                        } else {
                            notificationManager.error(i18n.t("settings.notifications.saveFailed"));
                        }
                    } catch (error) {
                        notificationManager.error(i18n.t("settings.notifications.saveFailed"));
                    }
                }

                // 이벤트 리스너
                backBtn.addEventListener("click", function () {
                    window.location.href = "dashboard.html";
                });

                checkUpdatesToggle.addEventListener("change", saveSettings);
                showStatisticsToggle.addEventListener("change", saveSettings);
                languageSelect.addEventListener("change", saveSettings);

                // 보안 설정 이벤트 리스너
                autoLockToggle.addEventListener("change", function () {
                    updateTimeoutVisibility();
                    saveSettings();
                });
                autoLockTimeoutInput.addEventListener("change", saveSettings);
                screenCaptureToggle.addEventListener("change", saveSettings);

                // 초기 로드
                loadSettings();
            });
        </script>
    </body>
</html>
