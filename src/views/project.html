<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LocalKeys</title>
        <link rel="stylesheet" href="../styles/common.css" />
    </head>
    <body>
        <div class="container">
            <div class="page-header project-header">
                <div class="page-title project-title">
                    <button class="back-btn" id="back-btn">‚Üê</button>
                    <span id="project-name">Project</span>
                </div>
                <div class="header-actions">
                    <button class="btn" id="add-secret-btn">Add Secret</button>
                    <button class="btn btn-secondary" id="export-btn">Export .env</button>
                </div>
            </div>

            <!-- Í≤ÄÏÉâ Î∞î -->
            <div class="search-bar">
                <input type="text" class="search-input" id="search-input" placeholder="Search secrets..." />
                <span class="search-icon">üîç</span>
            </div>

            <!-- ÏãúÌÅ¨Î¶ø Î™©Î°ù -->
            <div class="secrets-container" id="secrets-container">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- ÏãúÌÅ¨Î¶ø Ï∂îÍ∞Ä Î™®Îã¨ -->
        <div id="add-secret-modal" class="modal-overlay hidden">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Secret</h3>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label for="secret-key">Key</label>
                        <input type="text" id="secret-key" placeholder="Enter secret key" autocomplete="off" />
                    </div>
                    <div class="input-group">
                        <label for="secret-value">Value</label>
                        <input type="text" id="secret-value" placeholder="Enter secret value" autocomplete="off" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-add-secret">Cancel</button>
                    <button class="btn" id="confirm-add-secret">Add Secret</button>
                </div>
            </div>
        </div>

        <!-- ÏãúÌÅ¨Î¶ø Ìé∏Ïßë Î™®Îã¨ -->
        <div id="edit-secret-modal" class="modal-overlay hidden">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Secret</h3>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label for="edit-secret-key">Key</label>
                        <input type="text" id="edit-secret-key" placeholder="Enter secret key" autocomplete="off" />
                    </div>
                    <div class="input-group">
                        <label for="edit-secret-value">Value</label>
                        <input type="text" id="edit-secret-value" placeholder="Enter secret value" autocomplete="off" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-edit-secret">Cancel</button>
                    <button class="btn" id="confirm-edit-secret">Save Changes</button>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const projectNameEl = document.getElementById("project-name");
                const secretsContainer = document.getElementById("secrets-container");
                const searchInput = document.getElementById("search-input");
                const backBtn = document.getElementById("back-btn");
                const addSecretBtn = document.getElementById("add-secret-btn");
                const exportBtn = document.getElementById("export-btn");

                // Î™®Îã¨ ÏöîÏÜå
                const addSecretModal = document.getElementById("add-secret-modal");
                const editSecretModal = document.getElementById("edit-secret-modal");
                const secretKeyInput = document.getElementById("secret-key");
                const secretValueInput = document.getElementById("secret-value");
                const editSecretKeyInput = document.getElementById("edit-secret-key");
                const editSecretValueInput = document.getElementById("edit-secret-value");
                const cancelAddSecret = document.getElementById("cancel-add-secret");
                const confirmAddSecret = document.getElementById("confirm-add-secret");
                const cancelEditSecret = document.getElementById("cancel-edit-secret");
                const confirmEditSecret = document.getElementById("confirm-edit-secret");

                let projectName = "";
                let secrets = {};
                let filteredSecrets = {};
                let editingKey = "";

                // URLÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
                function getProjectNameFromURL() {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get("name") || "";
                }

                // ÏãúÌÅ¨Î¶ø Î°úÎìú
                async function loadSecrets() {
                    try {
                        const result = await window.localkeys.secrets.getAll(projectName);

                        if (result.success) {
                            secrets = result.data;
                            filteredSecrets = secrets;
                            renderSecrets();
                        } else {
                            showError("Failed to load secrets");
                        }
                    } catch (error) {
                        showError(`Error loading secrets: ${error.message}`);
                    }
                }

                // ÏãúÌÅ¨Î¶ø Î†åÎçîÎßÅ
                function renderSecrets() {
                    const secretKeys = Object.keys(filteredSecrets);

                    if (secretKeys.length === 0) {
                        secretsContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üîë</div>
              <div class="empty-state-title">No secrets found</div>
              <div class="empty-state-description">
                ${Object.keys(secrets).length === 0 ? "Add your first secret to this project." : "No secrets match your search criteria."}
              </div>
              ${Object.keys(secrets).length === 0 ? '<button class="btn" onclick="showAddSecretModal()">Add Secret</button>' : ""}
            </div>
          `;
                        return;
                    }

                    const secretsHTML = secretKeys
                        .map(
                            (key) => `
          <div class="secret-item">
            <div class="secret-header">
              <div class="secret-key">${escapeHtml(key)}</div>
              <div class="secret-actions">
                <button class="toggle-visibility" onclick="toggleVisibility('${key}')">üëÅÔ∏è</button>
                  <button class="btn btn-secondary" onclick="editSecret('${key}')">Edit</button>
                <button class="btn btn-danger" onclick="deleteSecret('${key}')">Delete</button>
              </div>
            </div>
            <div class="secret-value masked" id="value-${key}">${escapeHtml(filteredSecrets[key])}</div>
          </div>
        `
                        )
                        .join("");

                    secretsContainer.innerHTML = secretsHTML;
                }

                // ÏãúÌÅ¨Î¶ø Í∞ÄÏãúÏÑ± ÌÜ†Í∏Ä
                function toggleVisibility(key) {
                    const valueEl = document.getElementById(`value-${key}`);
                    valueEl.classList.toggle("masked");
                }

                // ÏãúÌÅ¨Î¶ø Ìé∏Ïßë
                function editSecret(key) {
                    showEditSecretModal(key, secrets[key]);
                }

                // ÏãúÌÅ¨Î¶ø ÏÇ≠Ï†ú
                async function deleteSecret(key) {
                    if (!confirm(`Are you sure you want to delete secret "${key}"?`)) {
                        return;
                    }

                    try {
                        const result = await window.localkeys.secrets.delete(projectName, key);

                        if (result.success) {
                            await loadSecrets();
                            showSuccess(`Secret "${key}" deleted successfully`);
                        } else {
                            showError(`Failed to delete secret: ${result.error}`);
                        }
                    } catch (error) {
                        showError(`Error deleting secret: ${error.message}`);
                    }
                }

                // ÏãúÌÅ¨Î¶ø Ï∂îÍ∞Ä Î™®Îã¨ ÌëúÏãú
                function showAddSecretModal() {
                    addSecretModal.classList.remove("hidden");
                    secretKeyInput.value = "";
                    secretValueInput.value = "";

                    // Îã§Ïùå ÌîÑÎ†àÏûÑÏóêÏÑú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
                    requestAnimationFrame(() => {
                        addSecretModal.classList.add("show");
                    });

                    secretKeyInput.focus();
                }

                // ÏãúÌÅ¨Î¶ø Ï∂îÍ∞Ä Î™®Îã¨ Ïà®Í∏∞Í∏∞
                function hideAddSecretModal() {
                    addSecretModal.classList.remove("show");
                    addSecretModal.classList.add("closing");

                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ÌõÑ Î™®Îã¨ ÏôÑÏ†ÑÌûà Ïà®Í∏∞Í∏∞
                    setTimeout(() => {
                        addSecretModal.classList.add("hidden");
                        addSecretModal.classList.remove("closing");
                    }, 250);
                }

                // ÏãúÌÅ¨Î¶ø Ìé∏Ïßë Î™®Îã¨ ÌëúÏãú
                function showEditSecretModal(key, value) {
                    editSecretModal.classList.remove("hidden");
                    editSecretKeyInput.value = key;
                    editSecretValueInput.value = value;
                    editingKey = key;

                    // Îã§Ïùå ÌîÑÎ†àÏûÑÏóêÏÑú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
                    requestAnimationFrame(() => {
                        editSecretModal.classList.add("show");
                    });

                    editSecretKeyInput.focus();
                }

                // ÏãúÌÅ¨Î¶ø Ìé∏Ïßë Î™®Îã¨ Ïà®Í∏∞Í∏∞
                function hideEditSecretModal() {
                    editSecretModal.classList.remove("show");
                    editSecretModal.classList.add("closing");

                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ÌõÑ Î™®Îã¨ ÏôÑÏ†ÑÌûà Ïà®Í∏∞Í∏∞
                    setTimeout(() => {
                        editSecretModal.classList.add("hidden");
                        editSecretModal.classList.remove("closing");
                    }, 250);

                    editingKey = "";
                }

                // ÏãúÌÅ¨Î¶ø Ï∂îÍ∞Ä
                async function addSecret() {
                    const key = secretKeyInput.value.trim();
                    const value = secretValueInput.value;

                    if (!key) {
                        showError("Please enter a secret key");
                        return;
                    }

                    if (secrets.hasOwnProperty(key)) {
                        showError("A secret with this key already exists");
                        return;
                    }

                    try {
                        const result = await window.localkeys.secrets.set(projectName, key, value);

                        if (result.success) {
                            hideAddSecretModal();
                            await loadSecrets();
                            showSuccess(`Secret "${key}" added successfully`);
                        } else {
                            showError(`Failed to add secret: ${result.error}`);
                        }
                    } catch (error) {
                        showError(`Error adding secret: ${error.message}`);
                    }
                }

                // ÏãúÌÅ¨Î¶ø Ìé∏Ïßë Ï†ÄÏû•
                async function saveSecret() {
                    const key = editSecretKeyInput.value.trim();
                    const value = editSecretValueInput.value;

                    if (!key) {
                        showError("Please enter a secret key");
                        return;
                    }

                    // ÌÇ§Í∞Ä Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞
                    if (key !== editingKey && secrets.hasOwnProperty(key)) {
                        showError("A secret with this key already exists");
                        return;
                    }

                    try {
                        // ÌÇ§Í∞Ä Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ Í∏∞Ï°¥ ÌÇ§ ÏÇ≠Ï†ú ÌõÑ ÏÉà ÌÇ§Î°ú Ï∂îÍ∞Ä
                        if (key !== editingKey) {
                            await window.localkeys.secrets.delete(projectName, editingKey);
                        }

                        const result = await window.localkeys.secrets.set(projectName, key, value);

                        if (result.success) {
                            hideEditSecretModal();
                            await loadSecrets();
                            showSuccess(`Secret "${key}" saved successfully`);
                        }
                    } catch (error) {
                        showError(`Error saving secret: ${error.message}`);
                    }
                }

                // .env ÌååÏùºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                async function exportAsEnv() {
                    try {
                        const result = await window.localkeys.secrets.export(projectName);

                        if (result.success) {
                            showSuccess(`Secrets exported to ${result.path}`);
                        }
                    } catch (error) {
                        showError(`Error exporting secrets: ${error.message}`);
                    }
                }

                // Í≤ÄÏÉâ
                function searchSecrets() {
                    const query = searchInput.value.toLowerCase().trim();

                    if (!query) {
                        filteredSecrets = secrets;
                    } else {
                        filteredSecrets = {};
                        Object.keys(secrets).forEach((key) => {
                            if (key.toLowerCase().includes(query)) {
                                filteredSecrets[key] = secrets[key];
                            }
                        });
                    }

                    renderSecrets();
                }

                // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
                function escapeHtml(text) {
                    const div = document.createElement("div");
                    div.textContent = text;
                    return div.innerHTML;
                }

                function showSuccess(message) {
                    showMessage(message, "success");
                }

                function showError(message) {
                    showMessage(message, "error");
                }

                function showMessage(message, type) {
                    // Í∏∞Ï°¥ Î©îÏãúÏßÄÎì§Ïù¥ ÏûàÎã§Î©¥ Ï†úÍ±∞
                    const existingMessages = document.querySelectorAll('.message');
                    existingMessages.forEach(msg => {
                        if (msg.parentNode) {
                            msg.remove();
                        }
                    });

                    const messageEl = document.createElement("div");
                    messageEl.className = `message message-${type}`;

                    // ÏïÑÏù¥ÏΩò Í≤∞Ï†ï
                    let icon = '‚úì';
                    if (type === 'error') icon = '‚úï';
                    else if (type === 'warning') icon = '‚ö†';

                    messageEl.innerHTML = `
                        <div class="message-content">
                            <div class="message-header">
                                <div class="message-left">
                                    <div class="message-icon">${icon}</div>
                                    <div class="message-text">${escapeHtml(message)}</div>
                                </div>
                            </div>
                            <button class="message-close">√ó</button>
                        </div>
                    `;

                    document.body.appendChild(messageEl);

                    // Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ ÏúÑÌï¥ ÏïΩÍ∞ÑÏùò ÎîúÎ†àÏù¥ ÌõÑ show ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
                    setTimeout(() => {
                        messageEl.classList.add('show');
                    }, 10);

                    // Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
                    const closeBtn = messageEl.querySelector('.message-close');
                    closeBtn.addEventListener('click', () => {
                        hideMessage(messageEl);
                    });

                    // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÏïåÎ¶º Ï†ÄÏû•
                    saveNotificationToStorage(message, type);
                }

                function hideMessage(messageEl) {
                    messageEl.classList.add('hide');
                    // ÏïåÎ¶ºÏùÑ Îã´ÏùÑ Îïå Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Ï†úÍ±∞
                    localStorage.removeItem('localkeys_notifications');

                    // Ïï†ÎãàÎ©îÏù¥ÏÖòÏù¥ ÎÅùÎÇú ÌõÑ DOMÏóêÏÑú Ï†úÍ±∞
                    setTimeout(() => {
                        if (document.body.contains(messageEl)) {
                            document.body.removeChild(messageEl);
                        }
                    }, 300);
                }

                // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                searchInput.addEventListener("input", searchSecrets);
                backBtn.addEventListener("click", function () {
                    window.location.href = "dashboard.html";
                });
                addSecretBtn.addEventListener("click", showAddSecretModal);
                exportBtn.addEventListener("click", exportAsEnv);

                cancelAddSecret.addEventListener("click", hideAddSecretModal);
                confirmAddSecret.addEventListener("click", addSecret);
                cancelEditSecret.addEventListener("click", hideEditSecretModal);
                confirmEditSecret.addEventListener("click", saveSecret);

                secretKeyInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        secretValueInput.focus();
                    }
                });

                secretValueInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        addSecret();
                    }
                });

                editSecretKeyInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        editSecretValueInput.focus();
                    }
                });

                editSecretValueInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        saveSecret();
                    }
                });

                // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Í∞êÏßÄÎ•º ÏúÑÌïú Î≥ÄÏàò
                let mouseDownTarget = null;

                // ÎßàÏö∞Ïä§ Îã§Ïö¥ Ïù¥Î≤§Ìä∏ Ï∂îÏ†Å
                document.addEventListener("mousedown", function (e) {
                    mouseDownTarget = e.target;
                });

                addSecretModal.addEventListener("click", function (e) {
                    // ÌÅ¥Î¶≠ ÏãúÏûëÍ≥º ÎÅù Î™®Îëê Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥Ïù∏ Í≤ΩÏö∞ÏóêÎßå Îã´Í∏∞
                    if (mouseDownTarget === addSecretModal && e.target === addSecretModal) {
                        hideAddSecretModal();
                    }
                });

                editSecretModal.addEventListener("click", function (e) {
                    // ÌÅ¥Î¶≠ ÏãúÏûëÍ≥º ÎÅù Î™®Îëê Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥Ïù∏ Í≤ΩÏö∞ÏóêÎßå Îã´Í∏∞
                    if (mouseDownTarget === editSecretModal && e.target === editSecretModal) {
                        hideEditSecretModal();
                    }
                });

                // ÎßàÏö∞Ïä§ ÏóÖ Ïù¥Î≤§Ìä∏ Ï∂îÏ†Å - ÌÅ¥Î¶≠ Ìï¥Ï†úÎèÑ Î∞ñÏóêÏÑú Ìï¥Ïïº Ìï®
                document.addEventListener("mouseup", function (e) {
                    // ÌÅ¥Î¶≠ ÏãúÏûëÏù¥ Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥ÏòÄÏßÄÎßå ÌÅ¥Î¶≠ Ìï¥Ï†úÍ∞Ä Î™®Îã¨ Ïô∏Î∂ÄÏù∏ Í≤ΩÏö∞ Î™®Îã¨ Îã´Í∏∞
                    if ((mouseDownTarget === addSecretModal && e.target !== addSecretModal) ||
                        (mouseDownTarget === editSecretModal && e.target !== editSecretModal)) {
                        mouseDownTarget = null; // Ï¥àÍ∏∞Ìôî
                        return;
                    }
                });

                // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù (HTML onclickÏóêÏÑú ÏÇ¨Ïö©)
                window.toggleVisibility = toggleVisibility;
                window.editSecret = editSecret;
                window.deleteSecret = deleteSecret;
                window.showAddSecretModal = showAddSecretModal;

                // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏÑ§Ï†ï (5Ï¥àÎßàÎã§)
                const autoRefreshInterval = setInterval(async () => {
                    if (document.visibilityState === "visible") {
                        await loadSecrets();
                    }
                }, 5000);

                // ÌéòÏù¥ÏßÄÍ∞Ä Î≥¥Ïù¥ÏßÄ ÏïäÏùÑ ÎïåÎäî ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ï§ëÏßÄ
                document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === "hidden") {
                        clearInterval(autoRefreshInterval);
                    }
                });

                // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•Îêú ÏïåÎ¶º Î∂àÎü¨Ïò§Í∏∞
                function loadStoredNotifications() {
                    const stored = localStorage.getItem('localkeys_notifications');
                    if (stored) {
                        try {
                            const notifications = JSON.parse(stored);
                            if (notifications && notifications.length > 0) {
                                // Í∞ÄÏû• ÏµúÍ∑º ÏïåÎ¶ºÎßå ÌëúÏãú
                                const latestNotification = notifications[notifications.length - 1];
                                showMessageStatic(latestNotification.message, latestNotification.type);

                                // ÌëúÏãú ÌõÑÏóêÎèÑ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ïú†ÏßÄ (ÏÇ¨Ïö©ÏûêÍ∞Ä Îã´ÏùÑ Îïå Ï†úÍ±∞)
                            }
                        } catch (error) {
                            console.error('Failed to load stored notifications:', error);
                            localStorage.removeItem('localkeys_notifications');
                        }
                    }
                }

                // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏóÜÏù¥ ÏïåÎ¶º ÌëúÏãú (Ï†ÄÏû•Îêú ÏïåÎ¶ºÏö©)
                function showMessageStatic(message, type) {
                    // Í∏∞Ï°¥ Î©îÏãúÏßÄÎì§Ïù¥ ÏûàÎã§Î©¥ Ï†úÍ±∞
                    const existingMessages = document.querySelectorAll('.message');
                    existingMessages.forEach(msg => {
                        if (msg.parentNode) {
                            msg.remove();
                        }
                    });

                    const messageEl = document.createElement("div");
                    messageEl.className = `message message-${type}`;

                    // ÏïÑÏù¥ÏΩò Í≤∞Ï†ï
                    let icon = '‚úì';
                    if (type === 'error') icon = '‚úï';
                    else if (type === 'warning') icon = '‚ö†';

                    messageEl.innerHTML = `
                        <div class="message-content">
                            <div class="message-header">
                                <div class="message-left">
                                    <div class="message-icon">${icon}</div>
                                    <div class="message-text">${escapeHtml(message)}</div>
                                </div>
                            </div>
                            <button class="message-close">√ó</button>
                        </div>
                    `;

                    document.body.appendChild(messageEl);

                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏóÜÏù¥ Î∞îÎ°ú ÌëúÏãú
                    messageEl.style.right = '20px';
                    messageEl.style.bottom = '20px';
                    messageEl.style.opacity = '1';

                    // Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
                    const closeBtn = messageEl.querySelector('.message-close');
                    closeBtn.addEventListener('click', () => {
                        hideMessage(messageEl);
                    });
                }

                // ÏïåÎ¶ºÏùÑ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
                function saveNotificationToStorage(message, type) {
                    try {
                        const stored = localStorage.getItem('localkeys_notifications');
                        const notifications = stored ? JSON.parse(stored) : [];

                        // ÏÉà ÏïåÎ¶º Ï∂îÍ∞Ä (ÏµúÎåÄ 5Í∞úÍπåÏßÄ Ïú†ÏßÄ)
                        notifications.push({ message, type, timestamp: Date.now() });
                        if (notifications.length > 5) {
                            notifications.splice(0, notifications.length - 5);
                        }

                        localStorage.setItem('localkeys_notifications', JSON.stringify(notifications));
                    } catch (error) {
                        console.error('Failed to save notification:', error);
                    }
                }

                // Ï¥àÍ∏∞Ìôî
                projectName = getProjectNameFromURL();
                if (projectName) {
                    projectNameEl.textContent = projectName;
                    loadSecrets();
                    // Ï†ÄÏû•Îêú ÏïåÎ¶º Î∂àÎü¨Ïò§Í∏∞
                    loadStoredNotifications();
                } else {
                    showError("No project specified");
                    setTimeout(() => {
                        window.location.href = "dashboard.html";
                    }, 2000);
                }
            });
        </script>
    </body>
</html>
