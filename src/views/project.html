<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LocalKeys</title>
        <link rel="stylesheet" href="../styles/common.css" />
    </head>
    <body>
        <div class="container">
            <div class="page-header project-header">
                <div class="page-title">
                    <button class="back-btn" id="back-btn">‚Üê</button>
                    <span id="project-name">Project</span>
                </div>
                <div class="header-actions">
                    <button class="btn" id="add-secret-btn">Add Secret</button>
                    <button class="btn btn-secondary" id="import-btn">Import</button>
                    <button class="btn btn-secondary" id="export-btn">Export</button>
                </div>
            </div>

            <!-- Í≤ÄÏÉâ Î∞î -->
            <div class="search-bar">
                <input type="text" class="search-input" id="search-input" placeholder="Search secrets..." />
                <span class="search-icon">üîç</span>
            </div>

            <!-- ÏãúÌÅ¨Î¶ø Î™©Î°ù -->
            <div class="secrets-container" id="secrets-container">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- ÏãúÌÅ¨Î¶ø Ï∂îÍ∞Ä Î™®Îã¨ -->
        <div id="add-secret-modal" class="modal-overlay hidden">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="add-modal-title">Add New Secret</h3>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label for="secret-key" id="label-secret-key">Key</label>
                        <input type="text" id="secret-key" placeholder="Enter secret key" autocomplete="off" />
                    </div>
                    <div class="input-group">
                        <label for="secret-value" id="label-secret-value">Value</label>
                        <input type="text" id="secret-value" placeholder="Enter secret value" autocomplete="off" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-add-secret">Cancel</button>
                    <button class="btn" id="confirm-add-secret">Add Secret</button>
                </div>
            </div>
        </div>

        <!-- ÏãúÌÅ¨Î¶ø Ìé∏Ïßë Î™®Îã¨ -->
        <div id="edit-secret-modal" class="modal-overlay hidden">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="edit-modal-title">Edit Secret</h3>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label for="edit-secret-key" id="label-edit-key">Key</label>
                        <input type="text" id="edit-secret-key" placeholder="Enter secret key" autocomplete="off" />
                    </div>
                    <div class="input-group">
                        <label for="edit-secret-value" id="label-edit-value">Value</label>
                        <input type="text" id="edit-secret-value" placeholder="Enter secret value" autocomplete="off" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-edit-secret">Cancel</button>
                    <button class="btn" id="confirm-edit-secret">Save Changes</button>
                </div>
            </div>
        </div>

        <script src="../modules/i18n-helper.js"></script>
        <script src="../modules/notification.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", async function () {
                // Îã§Íµ≠Ïñ¥ Ï¥àÍ∏∞Ìôî
                await i18n.init();

                // UI Î≤àÏó≠ Ï†ÅÏö©
                document.getElementById("add-secret-btn").textContent = i18n.t("project.addSecret");
                document.getElementById("import-btn").textContent = i18n.t("project.importEnv");
                document.getElementById("export-btn").textContent = i18n.t("project.exportEnv");
                document.getElementById("search-input").placeholder = i18n.t("project.searchPlaceholder");
                document.getElementById("add-modal-title").textContent = i18n.t("project.addSecretModal.title");
                document.getElementById("label-secret-key").textContent = i18n.t("project.addSecretModal.keyLabel");
                document.getElementById("secret-key").placeholder = i18n.t("project.addSecretModal.keyPlaceholder");
                document.getElementById("label-secret-value").textContent = i18n.t("project.addSecretModal.valueLabel");
                document.getElementById("secret-value").placeholder = i18n.t("project.addSecretModal.valuePlaceholder");
                document.getElementById("cancel-add-secret").textContent = i18n.t("common.cancel");
                document.getElementById("confirm-add-secret").textContent = i18n.t("project.addSecretModal.add");
                document.getElementById("edit-modal-title").textContent = i18n.t("project.editSecretModal.title");
                document.getElementById("label-edit-key").textContent = i18n.t("project.editSecretModal.keyLabel");
                document.getElementById("label-edit-value").textContent = i18n.t("project.editSecretModal.valueLabel");
                document.getElementById("cancel-edit-secret").textContent = i18n.t("common.cancel");
                document.getElementById("confirm-edit-secret").textContent = i18n.t("project.editSecretModal.save");
                const projectNameEl = document.getElementById("project-name");
                const secretsContainer = document.getElementById("secrets-container");
                const searchInput = document.getElementById("search-input");
                const backBtn = document.getElementById("back-btn");
                const addSecretBtn = document.getElementById("add-secret-btn");
                const exportBtn = document.getElementById("export-btn");
                const importBtn = document.getElementById("import-btn");

                // Î™®Îã¨ ÏöîÏÜå
                const addSecretModal = document.getElementById("add-secret-modal");
                const editSecretModal = document.getElementById("edit-secret-modal");
                const secretKeyInput = document.getElementById("secret-key");
                const secretValueInput = document.getElementById("secret-value");
                const editSecretKeyInput = document.getElementById("edit-secret-key");
                const editSecretValueInput = document.getElementById("edit-secret-value");
                const cancelAddSecret = document.getElementById("cancel-add-secret");
                const confirmAddSecret = document.getElementById("confirm-add-secret");
                const cancelEditSecret = document.getElementById("cancel-edit-secret");
                const confirmEditSecret = document.getElementById("confirm-edit-secret");

                let projectName = "";
                let secrets = {};
                let filteredSecrets = {};
                let editingKey = "";

                // URLÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
                function getProjectNameFromURL() {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get("name") || "";
                }

                // ÏãúÌÅ¨Î¶ø Î°úÎìú
                async function loadSecrets() {
                    try {
                        const result = await window.localkeys.secrets.getAll(projectName);

                        if (result.success) {
                            secrets = result.data;
                            filteredSecrets = secrets;
                            renderSecrets();
                        } else {
                            notificationManager.error(i18n.t("project.notifications.failedToLoad"));
                        }
                    } catch (error) {
                        notificationManager.error(i18n.t("project.notifications.failedToLoad"));
                    }
                }

                function createSecretRow(key, value) {
                    const item = document.createElement("div");
                    item.className = "secret-item";

                    const header = document.createElement("div");
                    header.className = "secret-header";

                    const keyDiv = document.createElement("div");
                    keyDiv.className = "secret-key";
                    keyDiv.textContent = key;

                    const actionsDiv = document.createElement("div");
                    actionsDiv.className = "secret-actions";

                    const toggleBtn = document.createElement("button");
                    toggleBtn.className = "toggle-visibility";
                    toggleBtn.textContent = "üëÅÔ∏è";
                    toggleBtn.onclick = () => toggleVisibility(key);

                    const editBtn = document.createElement("button");
                    editBtn.className = "btn btn-secondary";
                    editBtn.textContent = i18n.t("project.edit");
                    editBtn.onclick = () => editSecret(key);

                    const dropdownDiv = document.createElement("div");
                    dropdownDiv.className = "dropdown";

                    const dropdownBtn = document.createElement("button");
                    dropdownBtn.className = "btn btn-secondary dropdown-toggle";
                    dropdownBtn.textContent = "‚ãØ";
                    dropdownBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleDropdown(key);
                    };

                    const dropdownMenu = document.createElement("div");
                    dropdownMenu.className = "dropdown-menu hidden";
                    dropdownMenu.id = `dropdown-${key}`;

                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "dropdown-item dropdown-item-danger";
                    deleteBtn.textContent = i18n.t("project.deleteSecret");
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteSecret(key);
                    };

                    dropdownMenu.appendChild(deleteBtn);
                    dropdownDiv.appendChild(dropdownBtn);
                    dropdownDiv.appendChild(dropdownMenu);
                    actionsDiv.appendChild(toggleBtn);
                    actionsDiv.appendChild(editBtn);
                    actionsDiv.appendChild(dropdownDiv);
                    header.appendChild(keyDiv);
                    header.appendChild(actionsDiv);

                    const valueDiv = document.createElement("div");
                    valueDiv.className = "secret-value masked";
                    valueDiv.id = `value-${key}`;
                    valueDiv.textContent = value;

                    item.appendChild(header);
                    item.appendChild(valueDiv);

                    return item;
                }

                function createEmptyStateElement() {
                    const emptyState = document.createElement("div");
                    emptyState.className = "empty-state";

                    const icon = document.createElement("div");
                    icon.className = "empty-state-icon";
                    icon.textContent = "üîë";

                    const title = document.createElement("div");
                    title.className = "empty-state-title";
                    title.textContent = i18n.t("project.emptyState.title");

                    const description = document.createElement("div");
                    description.className = "empty-state-description";
                    description.textContent = Object.keys(secrets).length === 0 ? i18n.t("project.emptyState.descriptionEmpty") : i18n.t("project.emptyState.descriptionSearch");

                    emptyState.appendChild(icon);
                    emptyState.appendChild(title);
                    emptyState.appendChild(description);

                    if (Object.keys(secrets).length === 0) {
                        const addBtn = document.createElement("button");
                        addBtn.className = "btn";
                        addBtn.textContent = i18n.t("project.addSecret");
                        addBtn.onclick = showAddSecretModal;
                        emptyState.appendChild(addBtn);
                    }
                    return emptyState;
                }

                // ÏãúÌÅ¨Î¶ø Î†åÎçîÎßÅ
                function renderSecrets() {
                    secretsContainer.innerHTML = ""; // Clear existing content
                    const secretKeys = Object.keys(filteredSecrets);

                    if (secretKeys.length === 0) {
                        secretsContainer.appendChild(createEmptyStateElement());
                        return;
                    }

                    const fragment = document.createDocumentFragment();
                    secretKeys.forEach((key) => {
                        fragment.appendChild(createSecretRow(key, filteredSecrets[key]));
                    });
                    secretsContainer.appendChild(fragment);
                }

                // ÏãúÌÅ¨Î¶ø Í∞ÄÏãúÏÑ± ÌÜ†Í∏Ä
                function toggleVisibility(key) {
                    const valueEl = document.getElementById(`value-${key}`);
                    valueEl.classList.toggle("masked");
                }

                // ÏãúÌÅ¨Î¶ø Ìé∏Ïßë
                function editSecret(key) {
                    showEditSecretModal(key, secrets[key]);
                }

                // ÏãúÌÅ¨Î¶ø ÏÇ≠Ï†ú
                async function deleteSecret(key) {
                    if (!confirm(i18n.t("project.deleteConfirm", { key: key }))) {
                        return;
                    }

                    try {
                        const result = await window.localkeys.secrets.delete(projectName, key);

                        if (result.success) {
                            await loadSecrets();
                            notificationManager.success(i18n.t("project.notifications.secretDeleted", { key: key }));
                        } else {
                            notificationManager.error(i18n.t("project.notifications.failedToDelete"));
                        }
                    } catch (error) {
                        notificationManager.error(i18n.t("project.notifications.failedToDelete"));
                    }
                }

                // ÏãúÌÅ¨Î¶ø Ï∂îÍ∞Ä Î™®Îã¨ ÌëúÏãú
                function showAddSecretModal() {
                    addSecretModal.classList.remove("hidden");
                    secretKeyInput.value = "";
                    secretValueInput.value = "";

                    // Îã§Ïùå ÌîÑÎ†àÏûÑÏóêÏÑú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
                    requestAnimationFrame(() => {
                        addSecretModal.classList.add("show");
                    });

                    secretKeyInput.focus();
                }

                // ÏãúÌÅ¨Î¶ø Ï∂îÍ∞Ä Î™®Îã¨ Ïà®Í∏∞Í∏∞
                function hideAddSecretModal() {
                    addSecretModal.classList.remove("show");
                    addSecretModal.classList.add("closing");

                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ÌõÑ Î™®Îã¨ ÏôÑÏ†ÑÌûà Ïà®Í∏∞Í∏∞
                    setTimeout(() => {
                        addSecretModal.classList.add("hidden");
                        addSecretModal.classList.remove("closing");
                    }, 250);
                }

                // ÏãúÌÅ¨Î¶ø Ìé∏Ïßë Î™®Îã¨ ÌëúÏãú
                function showEditSecretModal(key, value) {
                    editSecretModal.classList.remove("hidden");
                    editSecretKeyInput.value = key;
                    editSecretValueInput.value = value;
                    editingKey = key;

                    // Îã§Ïùå ÌîÑÎ†àÏûÑÏóêÏÑú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
                    requestAnimationFrame(() => {
                        editSecretModal.classList.add("show");
                    });

                    editSecretKeyInput.focus();
                }

                // ÏãúÌÅ¨Î¶ø Ìé∏Ïßë Î™®Îã¨ Ïà®Í∏∞Í∏∞
                function hideEditSecretModal() {
                    editSecretModal.classList.remove("show");
                    editSecretModal.classList.add("closing");

                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ÌõÑ Î™®Îã¨ ÏôÑÏ†ÑÌûà Ïà®Í∏∞Í∏∞
                    setTimeout(() => {
                        editSecretModal.classList.add("hidden");
                        editSecretModal.classList.remove("closing");
                    }, 250);

                    editingKey = "";
                }

                // ÏãúÌÅ¨Î¶ø Ï∂îÍ∞Ä
                async function addSecret() {
                    const key = secretKeyInput.value.trim();
                    const value = secretValueInput.value;

                    if (!key) {
                        notificationManager.error(i18n.t("project.notifications.enterKey"));
                        return;
                    }

                    if (secrets.hasOwnProperty(key)) {
                        notificationManager.error(i18n.t("project.notifications.keyExists"));
                        return;
                    }

                    try {
                        const result = await window.localkeys.secrets.set(projectName, key, value);

                        if (result.success) {
                            hideAddSecretModal();
                            await loadSecrets();
                            notificationManager.success(i18n.t("project.notifications.secretAdded", { key: key }));
                        } else {
                            notificationManager.error(i18n.t("project.notifications.failedToAdd"));
                        }
                    } catch (error) {
                        notificationManager.error(i18n.t("project.notifications.failedToAdd"));
                    }
                }

                // ÏãúÌÅ¨Î¶ø Ìé∏Ïßë Ï†ÄÏû•
                async function saveSecret() {
                    const key = editSecretKeyInput.value.trim();
                    const value = editSecretValueInput.value;

                    if (!key) {
                        notificationManager.error(i18n.t("project.notifications.enterKey"));
                        return;
                    }

                    // ÌÇ§Í∞Ä Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞
                    if (key !== editingKey && secrets.hasOwnProperty(key)) {
                        notificationManager.error(i18n.t("project.notifications.keyExists"));
                        return;
                    }

                    try {
                        // ÌÇ§Í∞Ä Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ Í∏∞Ï°¥ ÌÇ§ ÏÇ≠Ï†ú ÌõÑ ÏÉà ÌÇ§Î°ú Ï∂îÍ∞Ä
                        if (key !== editingKey) {
                            await window.localkeys.secrets.delete(projectName, editingKey);
                        }

                        const result = await window.localkeys.secrets.set(projectName, key, value);

                        if (result.success) {
                            hideEditSecretModal();
                            await loadSecrets();
                            notificationManager.success(i18n.t("project.notifications.secretSaved", { key: key }));
                        }
                    } catch (error) {
                        notificationManager.error(i18n.t("project.notifications.failedToSave"));
                    }
                }

                // .env ÌååÏùºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                async function exportAsEnv() {
                    try {
                        const result = await window.localkeys.secrets.export(projectName);

                        if (result.success) {
                            notificationManager.success(i18n.t("project.notifications.exported", { path: result.path }));
                        }
                    } catch (error) {
                        notificationManager.error(i18n.t("project.notifications.failedToExport"));
                    }
                }

                // .env ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
                async function importEnv() {
                    try {
                        const result = await window.localkeys.secrets.import(projectName);

                        if (result.success) {
                            await loadSecrets();
                            notificationManager.success(i18n.t("project.notifications.imported", { count: result.count }));
                        } else if (result.error && result.error !== "Import cancelled") {
                            notificationManager.error(i18n.t("project.notifications.failedToImport"));
                        }
                    } catch (error) {
                        notificationManager.error(i18n.t("project.notifications.failedToImport"));
                    }
                }

                // Í≤ÄÏÉâ
                function searchSecrets() {
                    const query = searchInput.value.toLowerCase().trim();

                    if (!query) {
                        filteredSecrets = secrets;
                    } else {
                        filteredSecrets = {};
                        Object.keys(secrets).forEach((key) => {
                            if (key.toLowerCase().includes(query)) {
                                filteredSecrets[key] = secrets[key];
                            }
                        });
                    }

                    renderSecrets();
                }

                // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                searchInput.addEventListener("input", searchSecrets);
                backBtn.addEventListener("click", function () {
                    window.location.href = "dashboard.html";
                });
                addSecretBtn.addEventListener("click", showAddSecretModal);
                exportBtn.addEventListener("click", exportAsEnv);
                importBtn.addEventListener("click", importEnv);

                cancelAddSecret.addEventListener("click", hideAddSecretModal);
                confirmAddSecret.addEventListener("click", addSecret);
                cancelEditSecret.addEventListener("click", hideEditSecretModal);
                confirmEditSecret.addEventListener("click", saveSecret);

                secretKeyInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        secretValueInput.focus();
                    }
                });

                secretValueInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        addSecret();
                    }
                });

                editSecretKeyInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        editSecretValueInput.focus();
                    }
                });

                editSecretValueInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        saveSecret();
                    }
                });

                // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Í∞êÏßÄÎ•º ÏúÑÌïú Î≥ÄÏàò
                let mouseDownTarget = null;

                // ÎßàÏö∞Ïä§ Îã§Ïö¥ Ïù¥Î≤§Ìä∏ Ï∂îÏ†Å
                document.addEventListener("mousedown", function (e) {
                    mouseDownTarget = e.target;
                });

                addSecretModal.addEventListener("click", function (e) {
                    // ÌÅ¥Î¶≠ ÏãúÏûëÍ≥º ÎÅù Î™®Îëê Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥Ïù∏ Í≤ΩÏö∞ÏóêÎßå Îã´Í∏∞
                    if (mouseDownTarget === addSecretModal && e.target === addSecretModal) {
                        hideAddSecretModal();
                    }
                });

                editSecretModal.addEventListener("click", function (e) {
                    // ÌÅ¥Î¶≠ ÏãúÏûëÍ≥º ÎÅù Î™®Îëê Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥Ïù∏ Í≤ΩÏö∞ÏóêÎßå Îã´Í∏∞
                    if (mouseDownTarget === editSecretModal && e.target === editSecretModal) {
                        hideEditSecretModal();
                    }
                });

                // ÎßàÏö∞Ïä§ ÏóÖ Ïù¥Î≤§Ìä∏ Ï∂îÏ†Å - ÌÅ¥Î¶≠ Ìï¥Ï†úÎèÑ Î∞ñÏóêÏÑú Ìï¥Ïïº Ìï®
                document.addEventListener("mouseup", function (e) {
                    // ÌÅ¥Î¶≠ ÏãúÏûëÏù¥ Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥ÏòÄÏßÄÎßå ÌÅ¥Î¶≠ Ìï¥Ï†úÍ∞Ä Î™®Îã¨ Ïô∏Î∂ÄÏù∏ Í≤ΩÏö∞ Î™®Îã¨ Îã´Í∏∞
                    if ((mouseDownTarget === addSecretModal && e.target !== addSecretModal) || (mouseDownTarget === editSecretModal && e.target !== editSecretModal)) {
                        mouseDownTarget = null; // Ï¥àÍ∏∞Ìôî
                        return;
                    }
                });

                // ÎìúÎ°≠Îã§Ïö¥ ÌÜ†Í∏Ä Ìï®Ïàò
                function toggleDropdown(key) {
                    const dropdown = document.getElementById(`dropdown-${key}`);
                    const allDropdowns = document.querySelectorAll(".dropdown-menu");

                    // Îã§Î•∏ ÎìúÎ°≠Îã§Ïö¥ Î™®Îëê Îã´Í∏∞
                    allDropdowns.forEach((d) => {
                        if (d !== dropdown) {
                            d.classList.add("hidden");
                        }
                    });

                    // ÌòÑÏû¨ ÎìúÎ°≠Îã§Ïö¥ ÌÜ†Í∏Ä
                    dropdown.classList.toggle("hidden");
                }

                // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
                document.addEventListener("click", function (e) {
                    if (!e.target.closest(".dropdown")) {
                        const allDropdowns = document.querySelectorAll(".dropdown-menu");
                        allDropdowns.forEach((d) => d.classList.add("hidden"));
                    }
                });

                // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏÑ§Ï†ï (5Ï¥àÎßàÎã§)
                const autoRefreshInterval = setInterval(async () => {
                    if (document.visibilityState === "visible") {
                        await loadSecrets();
                    }
                }, 5000);

                // ÌéòÏù¥ÏßÄÍ∞Ä Î≥¥Ïù¥ÏßÄ ÏïäÏùÑ ÎïåÎäî ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ï§ëÏßÄ
                document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === "hidden") {
                        clearInterval(autoRefreshInterval);
                    }
                });

                // Ï¥àÍ∏∞Ìôî
                projectName = getProjectNameFromURL();
                if (projectName) {
                    projectNameEl.textContent = projectName;
                    loadSecrets();
                } else {
                    notificationManager.error(i18n.t("project.notifications.noProject"));
                    setTimeout(() => {
                        window.location.href = "dashboard.html";
                    }, 2000);
                }
            });
        </script>
    </body>
</html>
